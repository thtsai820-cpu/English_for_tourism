<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>English_for_tourism – Sentence Reader</title>
<style>
:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial;background:#f6f7fb;color:#111827;}
body{margin:0;}
.header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;}
.main{max-width:1100px;margin:0 auto;padding:16px;}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px;margin-bottom:12px;}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
.group{flex:1;min-width:220px;}
.label{font-size:12px;color:#6b7280;margin-bottom:6px;}
select,input[type="range"]{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff;}
button{border:1px solid #e5e7eb;background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;}
button.primary{background:#111827;color:#fff;border-color:#111827;}
button.danger{background:#fff1f2;border-color:#fecaca;}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.small{font-size:12px;color:#6b7280;line-height:1.5;}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
.s{padding:10px 12px;border:1px solid #e5e7eb;border-radius:14px;cursor:pointer;line-height:1.55;}
.s.active{background:#111827;border-color:#111827;color:#fff;}
.s.done{background:#ecfdf5;border-color:#16a34a;}
</style>
</head>
<body>
<div class="header"><b>Sentence Reader</b> <span class="small">（逐句朗讀＋高亮）</span></div>

<div class="main">
  <div class="card">
    <div class="small">JSON 目標路徑：<span class="mono">./guide_corpus_sentences.json</span></div>
    <div class="small">載入訊息：<span id="loadMsg" class="mono">loading...</span></div>
    <div class="small">Decks：<span id="deckCount" class="mono">-</span> ｜ First deck：<span id="firstDeck" class="mono">-</span></div>
  </div>

  <div class="card">
    <div class="row">
      <div class="group">
        <div class="label">Deck（PPT）</div>
        <select id="deckSel"></select>
      </div>
      <div class="group">
        <div class="label">Slide</div>
        <select id="slideSel"></select>
      </div>
      <div class="group">
        <div class="label">Rate：<span id="rateVal" class="mono">1.0</span></div>
        <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1.0" />
      </div>
    </div>

    <div class="actions">
      <button id="play" class="primary">▶ 播放</button>
      <button id="pause">⏸ 暫停</button>
      <button id="resume">⏵ 繼續</button>
      <button id="stop" class="danger">■ 停止</button>
    </div>

    <div class="small" style="margin-top:8px;">
      點句子可從該句開始播放。
    </div>
  </div>

  <div class="card">
    <div class="small" id="meta">—</div>
    <div id="sentBox"></div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
let DATA=null, deckIndex=0, slideIndex=0, cur=-1, isPlaying=false;

function setLoadMsg(t){ $("loadMsg").textContent = t; }
function setMeta(t){ $("meta").textContent = t; }
function getDeck(){ return DATA?.decks?.[deckIndex] || null; }
function getSlide(){ return getDeck()?.slides?.[slideIndex] || null; }
function getSentences(){ return getSlide()?.sentences || []; }

function renderSelectors(){
  const deckSel = $("deckSel");
  const slideSel = $("slideSel");
  deckSel.innerHTML = "";
  DATA.decks.forEach((d,i)=>{
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent=d.source_file || ("Deck "+(i+1));
    deckSel.appendChild(opt);
  });
  deckSel.value = String(deckIndex);

  slideSel.innerHTML="";
  getDeck().slides.forEach((s,i)=>{
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent = `Slide ${s.slide}` + (s.title_guess ? ` — ${s.title_guess}` : "");
    slideSel.appendChild(opt);
  });
  slideSel.value = String(slideIndex);
}

function mark(){
  const nodes=[...document.querySelectorAll(".s")];
  nodes.forEach((n,i)=>{
    n.classList.remove("active","done");
    if(i<cur) n.classList.add("done");
    if(i===cur) n.classList.add("active");
  });
}

function renderSentences(){
  const box=$("sentBox");
  box.innerHTML="";
  const d=getDeck(), s=getSlide(), arr=getSentences();
  setMeta(`${d.source_file} ｜ Slide ${s.slide}${s.title_guess ? " ｜ "+s.title_guess : ""}`);
  arr.forEach((t,i)=>{
    const div=document.createElement("div");
    div.className="s";
    div.textContent=t;
    div.onclick=()=>{ stop(); cur=i; mark(); playFromCur(); };
    box.appendChild(div);
  });
  mark();
}

function speak(text, onEnd){
  if(!("speechSynthesis" in window)){ alert("瀏覽器不支援 TTS"); return; }
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = Number($("rate").value || 1.0);
  u.onend = ()=> onEnd && onEnd();
  u.onerror = (e)=> { console.error(e); isPlaying=false; };
  speechSynthesis.speak(u);
}

function playFromCur(){
  const arr=getSentences();
  if(!arr.length) return;
  if(cur<0) cur=0;
  if(cur>=arr.length) cur=0;
  isPlaying=true;
  mark();
  speak(arr[cur], ()=>{
    if(!isPlaying) return;
    cur++;
    if(cur>=arr.length){ isPlaying=false; return; }
    mark();
    playFromCur();
  });
}
function stop(){ isPlaying=false; speechSynthesis?.cancel(); }
function pause(){ if(speechSynthesis?.speaking && !speechSynthesis.paused) speechSynthesis.pause(); }
function resume(){ if(speechSynthesis?.paused) speechSynthesis.resume(); }

$("rate").addEventListener("input", ()=> $("rateVal").textContent = Number($("rate").value).toFixed(1));
$("deckSel").addEventListener("change", ()=>{
  stop();
  deckIndex=Number($("deckSel").value||0); slideIndex=0; cur=0;
  renderSelectors(); renderSentences();
});
$("slideSel").addEventListener("change", ()=>{
  stop();
  slideIndex=Number($("slideSel").value||0); cur=0;
  renderSentences();
});
$("play").onclick=()=>{ if(!DATA) return alert("JSON 未載入"); playFromCur(); };
$("pause").onclick=()=>pause();
$("resume").onclick=()=>resume();
$("stop").onclick=()=>stop();

async function boot(){
  setLoadMsg("fetching JSON...");
  try{
    const res = await fetch("./guide_corpus_sentences.json", {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    DATA = json;

    $("deckCount").textContent = String(DATA.decks?.length ?? 0);
    $("firstDeck").textContent = String(DATA.decks?.[0]?.source_file ?? "-");

    if(!DATA.decks || !DATA.decks.length){
      setLoadMsg("JSON loaded but decks is empty / missing.");
      return;
    }
    deckIndex=0; slideIndex=0; cur=0;
    renderSelectors();
    renderSentences();
    setLoadMsg("OK");
  }catch(e){
    console.error(e);
    setLoadMsg("FAILED: " + (e.message || e));
  }
}
boot();
</script>
</body>
</html>

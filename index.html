<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>English_for_tourism – Sentence Listener</title>
<style>
:root{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial;
  background:#f6f7fb; color:#111827;
}
body{ margin:0; }
.header{ background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; }
.title{ font-weight:900; font-size:18px; }
.badge{
  display:inline-block; margin-left:8px;
  padding:3px 8px; border-radius:999px;
  border:1px solid #e5e7eb; font-size:12px; color:#374151; background:#fff;
}
.main{ max-width:1100px; margin:0 auto; padding:16px; }
.grid{ display:grid; grid-template-columns:1fr; gap:12px; }
@media (min-width: 980px){ .grid{ grid-template-columns: 400px 1fr; } }

.card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
.group{ flex:1; min-width:180px; }
.label{ font-size:12px; color:#6b7280; margin-bottom:6px; }
select, input[type="range"]{
  width:100%;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:10px 12px;
  font-size:14px;
  outline:none;
  background:#fff;
}
select:focus, input[type="range"]:focus{ border-color:#111827; }

.actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
button{
  border:1px solid #e5e7eb; background:#fff;
  padding:10px 12px; border-radius:12px;
  cursor:pointer; font-weight:900;
}
button.primary{ background:#111827; color:#fff; border-color:#111827; }
button.ghost{ background:#fff; }
button.danger{ background:#fff1f2; border-color:#fecaca; }
.small{ font-size:12px; color:#6b7280; line-height:1.5; }
.hr{ height:1px; background:#e5e7eb; border:0; margin:12px 0; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

.topline{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
.pill{
  display:inline-block; padding:3px 8px; border-radius:999px;
  border:1px solid #e5e7eb; font-size:12px; color:#374151;
}
.notice{
  padding:10px 12px; border:1px dashed #d1d5db;
  border-radius:12px; background:#fff;
}

.sentences{ display:flex; flex-direction:column; gap:8px; }
.s{
  padding:10px 12px;
  border:1px solid #e5e7eb;
  border-radius:14px;
  background:#fff;
  cursor:pointer;
  line-height:1.55;
}
.s:hover{ border-color:#9ca3af; }
.s.active{ background:#111827; border-color:#111827; color:#fff; }
.s.done{ background:#ecfdf5; border-color:#16a34a; }

.kpiLine{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
.kpi{ font-weight:900; font-size:13px; }
</style>
</head>

<body>
<div class="header">
  <div class="title">
    English for Tourism – Sentence Listener
    <span class="badge">逐句按、逐句聽（無自動續讀）</span>
  </div>
</div>

<div class="main">
  <div class="grid">

    <!-- 左：控制 -->
    <div class="card">
      <div class="label">資料</div>
      <div class="notice small">
        讀取：<span class="mono">./guide_corpus_sentences.json</span><br/>
        操作方式：點句子或按「播放本句 / 下一句」。
      </div>

      <div class="small" style="margin-top:8px;">
        載入訊息：<span id="loadMsg" class="mono">loading...</span>
      </div>

      <hr class="hr"/>

      <div class="row">
        <div class="group">
          <div class="label">Deck（PPT）</div>
          <select id="deckSel"></select>
        </div>
        <div class="group">
          <div class="label">Slide</div>
          <select id="slideSel"></select>
        </div>
      </div>

      <hr class="hr"/>

      <div class="row">
        <div class="group">
          <div class="label">Voice（英文語音）</div>
          <select id="voiceSel"></select>
          <div class="small">已自動優先排序較自然的 voice（若你的系統有提供）。</div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="group">
          <div class="label">語速 Rate：<span id="rateVal" class="mono">1.0</span></div>
          <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1.0" />
        </div>
        <div class="group">
          <div class="label">音高 Pitch：<span id="pitchVal" class="mono">1.0</span></div>
          <input id="pitch" type="range" min="0.7" max="1.3" step="0.1" value="1.0" />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="group">
          <div class="label">音量 Volume：<span id="volVal" class="mono">1.0</span></div>
          <input id="vol" type="range" min="0.2" max="1.0" step="0.1" value="1.0" />
        </div>
      </div>

      <div class="actions">
        <button id="playOne" class="primary">▶ 播放本句</button>
        <button id="replayOne" class="ghost">↻ 重播本句</button>
        <button id="nextOne" class="primary">下一句 ▶</button>
        <button id="pause" class="ghost">⏸ 暫停</button>
        <button id="resume" class="ghost">⏵ 繼續</button>
        <button id="stop" class="danger">■ 停止</button>
      </div>

      <div class="small" style="margin-top:8px;">
        建議參數：Rate 0.9～1.1、Pitch 0.9～1.1（可減少僵硬感）。
      </div>

      <hr class="hr"/>

      <div class="kpiLine">
        <div class="kpi">狀態：<span id="status" class="mono">loading</span></div>
        <div class="kpi">句子：<span id="count" class="mono">0</span></div>
        <div class="kpi">目前：<span id="idx" class="mono">-</span></div>
      </div>
    </div>

    <!-- 右：句子 -->
    <div class="card">
      <div class="topline">
        <div>
          <div style="font-weight:900; font-size:18px;">句子列表</div>
          <div class="small" id="meta">—</div>
        </div>
        <div class="pill" id="pill">loading</div>
      </div>

      <hr class="hr"/>

      <div id="sentBox" class="sentences"></div>

      <div class="small" style="margin-top:10px;">
        點任一句會「選取該句」並可播放。<br/>
        ✅ Done（綠）：你已經聽過　｜　⬛ Active（黑）：目前選取
      </div>
    </div>

  </div>
</div>

<script>
/* ============================================================
  Helpers
============================================================ */
const $ = (id)=>document.getElementById(id);
function setText(id, t){ $(id).textContent = t; }

/* ============================================================
  Data
============================================================ */
let DATA = null;
let deckIndex = 0;
let slideIndex = 0;
let currentSentIndex = 0;

/* ============================================================
  Status
============================================================ */
function setStatus(s){
  setText("status", s);
  $("pill").textContent = s;
}
function setLoadMsg(t){ setText("loadMsg", t); }

/* ============================================================
  Accessors
============================================================ */
function getDeck(){ return DATA?.decks?.[deckIndex] || null; }
function getSlide(){ return getDeck()?.slides?.[slideIndex] || null; }
function getSentences(){ return getSlide()?.sentences || []; }

/* ============================================================
  TTS (no auto-continue)
============================================================ */
let voices = [];
let speaking = false;
let lastSpokenIndex = -1;

function isEnglishVoice(v){
  return (v.lang || "").toLowerCase().startsWith("en");
}

// 優先挑「較自然」的 voice（若系統提供）
function voiceScore(v){
  const name = (v.name || "").toLowerCase();
  const lang = (v.lang || "").toLowerCase();

  let score = 0;

  // 優先英文
  if(isEnglishVoice(v)) score += 50;

  // 偏好 en-us / en-gb
  if(lang === "en-us") score += 20;
  if(lang === "en-gb") score += 18;

  // 偏好較自然的標記（不同系統可能不同）
  const goodHints = ["neural","natural","premium","enhanced","google","microsoft","zira","aria","jenny","guy","ryan","samantha","daniel","olivia"];
  for(const h of goodHints){
    if(name.includes(h)) { score += 6; break; }
  }

  // 避免太機械的常見標記（若遇到）
  const badHints = ["espeak","mbrola","default"];
  for(const b of badHints){
    if(name.includes(b)) { score -= 8; break; }
  }

  return score;
}

function loadVoices(){
  if(!("speechSynthesis" in window)){
    $("voiceSel").innerHTML = `<option>SpeechSynthesis not supported</option>`;
    return;
  }
  const all = window.speechSynthesis.getVoices() || [];
  const en = all.filter(isEnglishVoice);
  voices = (en.length ? en : all).slice();

  // sort by our scoring
  voices.sort((a,b)=> voiceScore(b) - voiceScore(a));

  $("voiceSel").innerHTML = "";
  voices.forEach((v,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${v.name} (${v.lang})`;
    $("voiceSel").appendChild(opt);
  });

  // choose best by default
  $("voiceSel").value = "0";
}

if("speechSynthesis" in window){
  window.speechSynthesis.onvoiceschanged = () => loadVoices();
}

function cleanSentenceForTTS(s){
  // 不改寫原文（A 原則），只做 TTS 朗讀友善的最小清理
  let t = (s || "").trim();
  t = t.replace(/\s+/g, " ");
  // 把奇怪的連續標點稍微拉順，避免 TTS 卡頓
  t = t.replace(/\.{3,}/g, "...");
  t = t.replace(/([!?]){2,}/g, "$1");
  return t;
}

function speakOnce(text){
  if(!("speechSynthesis" in window)){
    alert("此瀏覽器不支援 SpeechSynthesis。建議 Chrome / Edge。");
    return;
  }
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);

  const v = voices[Number($("voiceSel").value || 0)];
  if(v) u.voice = v;

  u.lang = v?.lang || "en-US";
  u.rate = Number($("rate").value || 1.0);
  u.pitch = Number($("pitch").value || 1.0);
  u.volume = Number($("vol").value || 1.0);

  // 句子前後給一點點停頓（用空白+逗點技巧讓 TTS 停一下）
  // 注意：不改句子內容，只在 utterance 層加入微停頓
  const prefixPause = " ";
  const suffixPause = " ";
  u.text = prefixPause + text + suffixPause;

  u.onstart = ()=>{ speaking = true; setStatus("speaking"); };
  u.onend = ()=>{ speaking = false; setStatus("ready"); };
  u.onerror = ()=>{ speaking = false; setStatus("error"); };

  window.speechSynthesis.speak(u);
}

function pauseSpeak(){
  if(window.speechSynthesis?.speaking && !window.speechSynthesis.paused){
    window.speechSynthesis.pause();
    setStatus("paused");
  }
}
function resumeSpeak(){
  if(window.speechSynthesis?.paused){
    window.speechSynthesis.resume();
    setStatus("speaking");
  }
}
function stopSpeak(){
  speaking = false;
  window.speechSynthesis?.cancel();
  setStatus("ready");
}

/* ============================================================
  Rendering
============================================================ */
function renderSelectors(){
  const deckSel = $("deckSel");
  const slideSel = $("slideSel");

  deckSel.innerHTML = "";
  DATA.decks.forEach((d,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = d.source_file || ("Deck " + (i+1));
    deckSel.appendChild(opt);
  });
  deckSel.value = String(deckIndex);

  slideSel.innerHTML = "";
  const d = getDeck();
  d.slides.forEach((s,i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    const label = `Slide ${s.slide}` + (s.title_guess ? ` — ${s.title_guess}` : "");
    opt.textContent = label.length > 80 ? label.slice(0,80) + "…" : label;
    slideSel.appendChild(opt);
  });
  slideSel.value = String(slideIndex);
}

function renderSentences(){
  const box = $("sentBox");
  box.innerHTML = "";

  const d = getDeck();
  const s = getSlide();
  const arr = getSentences();

  setText("count", String(arr.length));
  $("meta").textContent = `${d.source_file} ｜ Slide ${s.slide}${s.title_guess ? " ｜ " + s.title_guess : ""}`;

  // clamp current index
  if(currentSentIndex < 0) currentSentIndex = 0;
  if(currentSentIndex >= arr.length) currentSentIndex = Math.max(0, arr.length - 1);

  arr.forEach((t,i)=>{
    const div = document.createElement("div");
    div.className = "s";
    div.textContent = t;

    div.onclick = ()=>{
      stopSpeak();
      currentSentIndex = i;
      markSentences();
    };

    box.appendChild(div);
  });

  markSentences();
}

function markSentences(){
  const nodes = Array.from(document.querySelectorAll(".s"));
  nodes.forEach((n,i)=>{
    n.classList.remove("active","done");
    if(i < currentSentIndex) n.classList.add("done");
    if(i === currentSentIndex) n.classList.add("active");
  });
  setText("idx", (getSentences().length ? String(currentSentIndex+1) : "-"));
}

/* ============================================================
  Controls (no auto-continue)
============================================================ */
function playCurrent(){
  const arr = getSentences();
  if(!arr.length) return;
  const text = cleanSentenceForTTS(arr[currentSentIndex]);
  lastSpokenIndex = currentSentIndex;
  markSentences();
  speakOnce(text);
}
function replayCurrent(){
  if(lastSpokenIndex === -1){
    playCurrent();
    return;
  }
  currentSentIndex = lastSpokenIndex;
  playCurrent();
}
function nextSentence(){
  const arr = getSentences();
  if(!arr.length) return;
  stopSpeak();
  currentSentIndex = Math.min(currentSentIndex + 1, arr.length - 1);
  markSentences();
  playCurrent();
}

/* ============================================================
  Events
============================================================ */
$("rate").addEventListener("input", ()=> setText("rateVal", Number($("rate").value).toFixed(1)));
$("pitch").addEventListener("input", ()=> setText("pitchVal", Number($("pitch").value).toFixed(1)));
$("vol").addEventListener("input", ()=> setText("volVal", Number($("vol").value).toFixed(1)));

$("deckSel").addEventListener("change", ()=>{
  stopSpeak();
  deckIndex = Number($("deckSel").value || 0);
  slideIndex = 0;
  currentSentIndex = 0;
  lastSpokenIndex = -1;
  renderSelectors();
  renderSentences();
  setStatus("ready");
});
$("slideSel").addEventListener("change", ()=>{
  stopSpeak();
  slideIndex = Number($("slideSel").value || 0);
  currentSentIndex = 0;
  lastSpokenIndex = -1;
  renderSentences();
  setStatus("ready");
});

$("playOne").onclick = ()=> playCurrent();
$("replayOne").onclick = ()=> replayCurrent();
$("nextOne").onclick = ()=> nextSentence();
$("pause").onclick = ()=> pauseSpeak();
$("resume").onclick = ()=> resumeSpeak();
$("stop").onclick = ()=> stopSpeak();

/* ============================================================
  Boot
============================================================ */
async function boot(){
  setStatus("loading");
  setText("rateVal", Number($("rate").value).toFixed(1));
  setText("pitchVal", Number($("pitch").value).toFixed(1));
  setText("volVal", Number($("vol").value).toFixed(1));

  loadVoices();

  try{
    const res = await fetch("./guide_corpus_sentences.json", { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    if(!json?.decks?.length) throw new Error("JSON loaded but decks is empty/missing.");

    DATA = json;
    deckIndex = 0;
    slideIndex = 0;
    currentSentIndex = 0;
    lastSpokenIndex = -1;

    renderSelectors();
    renderSentences();
    setLoadMsg("OK");
    setStatus("ready");
  }catch(e){
    console.error(e);
    setLoadMsg("FAILED: " + (e.message || e));
    setStatus("load-failed");
    alert("載入 JSON 失敗：請確認 guide_corpus_sentences.json 與 index.html 同層，且 GitHub Pages 已更新。");
  }
}
boot();
</script>
</body>
</html>
